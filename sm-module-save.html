<link rel="import" href="../polymer/polymer.html"> <link rel="import" href="../sm-ui-core/sm-ui-core.html"> <link rel="import" href="../sm-ui-button/sm-ui-button.html"> <link rel="import" href="../sm-ui-user-menu/sm-ui-user-menu.html"> <link rel="import" href="../sm-utility-auth/sm-utility-auth.html"> <dom-module id="sm-module-save"> <template> <style include="sm-css-shady"></style><style include="sm-css"></style><style>:host{@apply(--typography);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-align:end;-webkit-align-items:flex-end;-ms-flex-align:end;align-items:flex-end;height:var(--tool-size);background:var(--blue);color:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);z-index:var(--on-top)}.save{padding:0 1.5em;font-weight:600;height:100%}.save[busy]{color:var(--med-white)}.menu{width:var(--tool-size);height:100%;border-left:1px solid var(--light-white)}</style><button is="sm-ui-button" on-tap="save" busy="[[busy]]" class="save">save</button> <sm-ui-user-menu id="menu" class="menu" callout="top right" email="[[user.email]]"> <sm-user-menu-item icon="simpla:exit" on-tap="logout">logout</sm-user-menu-item> </sm-ui-user-menu> <sm-utility-auth id="auth"></sm-utility-auth> </template> <script>!function(){"use strict";function e(e){var t=(new Date).getTime()/1e3,r=void 0;if(!e)return null;try{var i=e.split("."),s=n.slicedToArray(i,2),o=s[1];r=JSON.parse(atob(o))}catch(a){return console.warn("Invalid token",a.message),null}return r.exp&&t>r.exp?null:r}function t(){return simpla.notifications?simpla.notifications.notify.bind(simpla.notifications):function(e,t,n){console.info(n+": "+t)}}var n={};n.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n.createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),n.slicedToArray=function(){function e(e,t){var n=[],r=!0,i=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(r=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(u){i=!0,s=u}finally{try{!r&&a["return"]&&a["return"]()}finally{if(i)throw s}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();var r="https://api.simpla.io/users",i={properties:{user:Object},setUser:function(e){var t=this;fetch(r+"/"+e,{headers:makeHeaders({Authorization:"Bearer "+this.$.auth.token})}).then(function(e){return e.body()}).then(function(e){t.user=e})["catch"](function(e){t.user=null,console.warn("Fetching user failed:",e)})},ready:function(){var t=e(this.$.auth.token).sub;this.setUser(t)}},s={success:{type:"success",title:"Saved",message:"Hooray! Your changes are published"},warn:{type:"warning",title:"Uhhhh",message:"Looks like some things didn't save properly. Try again"},error:{type:"error",title:"Save Failed",message:"Oh no! Something went wrong, check your internet connection and try again"}},o={listeners:{saved:"_notifySuccess","save-failed":"_notifyFailed"},_notify:function(e){var n=t();n(e.type,e.message,e.title)},_notifySuccess:function(){this._notify(s.success)},_notifyFailed:function(e){var t=e.detail;this._notify(t.all?s.error:s.warn)}},a=function(){function e(){n.classCallCheck(this,e)}return n.createClass(e,[{key:"beforeRegister",value:function(){this.is="sm-module-save",this.properties={busy:Boolean},this.listeners={saving:"_beBusy",saved:"_stopBusy"}}},{key:"save",value:function(){var e=this,t=0,n=0,r=0,i=!1,s=void 0;this.fire("saving"),s=function(){0===r?e.fire("saved"):e.fire("save-failed",{all:0===n})},simpla.elements.forEach(function(e){var o=void 0,a=void 0,u=function(){return a(!0)},c=function(){return a(!1)};o=function(){t++,e.addEventListener("saved",u),e.addEventListener("error",c)},a=function(o){t--,e.removeEventListener("saved",u),e.removeEventListener("error",c),o?n++:r++,0===t&&i&&s()},e.save()&&o()}),i=!0}},{key:"_beBusy",value:function(){this.busy=!0}},{key:"_stopBusy",value:function(){this.busy=!1}},{key:"logout",value:function(){this.$.auth.logout()}},{key:"behaviors",get:function(){return[i,o]}}]),e}();Polymer(a)}();</script></dom-module>