<link rel="import" href="../polymer/polymer.html"> <link rel="import" href="../simpla-v2-compat/simpla-v2-compat.html"> <link rel="import" href="../sm-ui-core/sm-ui-core.html"> <link rel="import" href="../sm-ui-user-menu/sm-ui-user-menu.html"> <link rel="import" href="../sm-module-notify/sm-module-notify.html"> <dom-module id="sm-module-save"> <template> <style include="sm-css-shady"></style> <style include="sm-css"></style> <style>:host{@apply(--typography);display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end;height:var(--tool-size);background:var(--blue);color:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);z-index:var(--on-top);position:fixed;top:12px;right:12px}.save{padding:0 1.5em;font-weight:600;height:100%}.save[busy]{color:var(--med-white)}.menu{--user-menu-spacing:55px;width:var(--tool-size);height:100%;border-left:1px solid var(--light-white)}</style> <button is="sm-ui-button" on-tap="save" busy="[[busy]]" class="save">save</button> <sm-ui-user-menu id="menu" class="menu" callout="top right" user="[[user.email]]"> <sm-user-menu-item icon="simpla:exit" on-tap="logout">Logout</sm-user-menu-item> </sm-ui-user-menu> </template> <script>!function(){"use strict";function e(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign({},{"Content-Type":"application/json"},e)}function t(e){var t=(new Date).getTime()/1e3,n=void 0;if(!e)return null;try{var i=e.split("."),r=o(i,2),a=r[1];n=JSON.parse(atob(a))}catch(u){return console.warn("Invalid token",u.message),null}return n.exp&&t>n.exp?null:n}function n(){return simpla.notifications?simpla.notifications.notify.bind(simpla.notifications):function(e,t,n){console.info(n+": "+t)}}var i=(function(){function e(e){this.value=e}function t(t){function n(e,t){return new Promise(function(n,r){var u={key:e,arg:t,resolve:n,reject:r,next:null};a?a=a.next=u:(o=a=u,i(e,t))})}function i(n,o){try{var a=t[n](o),u=a.value;u instanceof e?Promise.resolve(u.value).then(function(e){i("next",e)},function(e){i("throw",e)}):r(a.done?"return":"normal",a.value)}catch(s){r("throw",s)}}function r(e,t){switch(e){case"return":o.resolve({value:t,done:!0});break;case"throw":o.reject(t);break;default:o.resolve({value:t,done:!1})}o=o.next,o?i(o.key,o.arg):a=null}var o,a;this._invoke=n,"function"!=typeof t["return"]&&(this["return"]=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype["throw"]=function(e){return this._invoke("throw",e)},t.prototype["return"]=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new t(e.apply(this,arguments))}},await:function(t){return new e(t)}}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=function(){function e(e,t){var n=[],i=!0,r=!1,o=void 0;try{for(var a,u=e[Symbol.iterator]();!(i=(a=u.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(s){r=!0,o=s}finally{try{!i&&u["return"]&&u["return"]()}finally{if(r)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a="https://api.simpla.io/users",u={properties:{token:{type:Object,observer:"_tokenChanged",value:Simpla._v1.getState().token},user:Object},created:function(){var e=this;Simpla._v1.observe("token",function(t){return e.token=t})},_tokenChanged:function(n){var i=this;n&&t(n)&&fetch(a+"/"+t(n).sub,{headers:e({Authorization:"Bearer "+n})}).then(function(e){return e.json()}).then(function(e){i.user=e})["catch"](function(e){i.user=null,console.warn("Fetching user failed:",e)})}},s={success:{type:"success",title:"Saved",message:"Hooray! Your changes are published"},warn:{type:"warning",title:"Uhhhh",message:"Looks like some things didn't save properly. Try again"},error:{type:"error",title:"Save Failed",message:"Oh no! Something went wrong, check your internet connection and try again"}},c={listeners:{saved:"_notifySuccess","save-failed":"_notifyFailed"},_notify:function(e){var t=n();t(e.type,e.message,e.title)},_notifySuccess:function(){this._notify(s.success)},_notifyFailed:function(e){var t=e.detail;this._notify(t.all?s.error:s.warn)}},l={properties:{_authenticated:{type:Boolean,value:function(){return Simpla._v1.getState().authenticated}},_editing:{type:Boolean,value:function(){return Simpla._v1.getState().editing}}},observers:["_updateHidden(_authenticated, _editing)"],created:function(){var e=this;Simpla._v1.observe("authenticated",function(t){e._authenticated=t}),Simpla._v1.observe("editing",function(t){e._editing=t})},ready:function(){this._updateHidden(this._authenticated,this._editing)},_updateHidden:function(e,t){e&&t?this.removeAttribute("hidden"):this.setAttribute("hidden","")}},f=document.createElement("sm-module-save");document.body?document.body.appendChild(f):document.addEventListener("readystatechange",function(){document.body&&document.body.appendChild(f)});var v=function(){function e(){i(this,e)}return r(e,[{key:"beforeRegister",value:function(){this.is="sm-module-save",this.properties={busy:Boolean},this.listeners={saving:"_beBusy",saved:"_stopBusy","save-failed":"_stopBusy"}}},{key:"save",value:function(){var e=this,t=0,n=0,i=0,r=!1,o=void 0,a=void 0;this.fire("saving"),o=Simpla.save?Simpla.save():Promise.resolve(),a=function(){var t=function(){e.fire("save-failed",{all:0===n})};o.then(function(){return 0!==i?Promise.reject():void e.fire("saved")})["catch"](t)},simpla.elements.forEach(function(e){var o=void 0,u=void 0,s=function(){return u(!0)},c=function(){return u(!1)};o=function(){t++,e.addEventListener("saved",s),e.addEventListener("error",c)},u=function(o){t--,e.removeEventListener("saved",s),e.removeEventListener("error",c),o?n++:i++,0===t&&r&&a()},e.save()&&o()}),r=!0,0===simpla.elements.length&&a()}},{key:"_beBusy",value:function(){this.busy=!0}},{key:"_stopBusy",value:function(){this.busy=!1}},{key:"logout",value:function(){return Simpla._v1.toggleEditing(!1),Simpla._v1.logout()}},{key:"behaviors",get:function(){return[u,c,l]}}]),e}();Polymer(v)}()</script> </dom-module>